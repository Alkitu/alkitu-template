# Theme System Audit — 2026-02-28

## Status: `tsc --noEmit` PASSES (0 errors)

The codebase compiles without TypeScript errors. However, multiple structural inconsistencies exist between the DB schema, the three CSS variable generators, and the type definitions. The system works today because of **resilient fallback patterns** in `globals.css` and in component-level inline styles, but the architecture is fragile.

---

## Issue 1: THREE INCOMPATIBLE TYPOGRAPHY TYPE SYSTEMS

**Severity: HIGH** — Causes silent data mismatches between SSR and runtime.

### System A — `src/types/typography.ts`
- Type: `ThemeTypography` with keys: `base`, `accent`, `quote`, `h1`–`h5`
- Values: `fontSize: number`, `lineHeight: number`, `letterSpacing: number` (numeric)
- Used by: `lib/theme/css-variables.ts` → `injectTypographyTokens()`
- Generates: `--typography-button-*`, `--typography-input-*`, `--typography-label-*`, `--typography-body-family`, `--typography-heading-family`

### System B — `theme-editor-3.0/theme-editor/editor/typography/types.ts`
- Type: `TypographyElements` with keys: `h1`–`h5`, `paragraph`, `quote`, `emphasis`
- Values: `fontSize: string`, `lineHeight: string`, `letterSpacing: string` (string with units)
- Used by: `theme-editor-3.0/lib/utils/css/css-variables.ts` → `applyTypographyElements()`
- Also used by: `lib/theme/inline-css-generator.ts` → `generateTypographyCSS()` (SSR)
- Generates: `--typography-h1-*`, `--typography-paragraph-*`, `--typography-emphasis-*` (8 properties each)

### System C — `theme-editor-3.0/core/types/theme.types.ts`
- Type: `ThemeTypography` with: `fontFamilies { sans, serif, mono }`, `trackingNormal`
- Used by: `theme-editor-3.0/lib/utils/css/css-variables.ts` → `applyThemeToRoot()`
- Generates: `--font-sans`, `--font-serif`, `--font-mono`, `--tracking-normal`

### Problem
- System A generates **component-specific** variables (`--typography-button-*`, `--typography-input-*`)
- System B generates **element-specific** variables (`--typography-h1-*`, `--typography-paragraph-*`)
- System C generates **global font families** only
- The `ThemeEditorContext` at runtime uses Systems B+C; the `lib/theme/css-variables.ts` utility uses System A
- SSR inline generator imports `DEFAULT_TYPOGRAPHY` from System B
- The `ThemeData.typography` field (System C) has no element-level data — it only stores `fontFamilies` + `trackingNormal`
- The DB `typography` JSON field is cast to `any` everywhere, so no type errors surface

### Impact
- `--typography-h1-*` through `--typography-emphasis-*` are generated by SSR and by the theme editor
- `--typography-button-*`, `--typography-input-*`, `--typography-label-*` are ONLY set by `injectTypographyTokens()` (System A) or as defaults in `globals.css`
- The theme editor **cannot modify** component-specific typography (button, input, label) because its type system doesn't include them
- `globals.css` defaults rescue this gap (lines 89–108)

### Recommendation
Unify into a single type that covers both element-level and component-level typography. Store it in the DB under a unified schema. Have one generator that produces all variables.

---

## Issue 2: `applyBorderElements()` MISSING COMPONENT-SPECIFIC RADII

**Severity: MEDIUM** — Component radii always come from CSS fallbacks, not DB values.

### What the runtime generates
`applyBorderElements()` sets: `--radius`, `--radius-sm/md/lg/xl`, `--radius-button`, `--radius-card`, `--radius-checkbox`, and their `-inner` variants (11 variables).

### What it does NOT generate
`--radius-input`, `--radius-dialog`, `--radius-popover`, `--radius-dropdown`, `--radius-tooltip`, `--radius-badge`, `--radius-tabs`, `--radius-select`, `--radius-toast` (9 variables).

### What UI components consume
| Component | CSS Variable Referenced |
|-----------|----------------------|
| `input.tsx` | `var(--radius-input, var(--radius, 0.375rem))` |
| `dialog.tsx` | `var(--radius-dialog, calc(var(--radius) + 8px))` |
| `select.tsx` | `var(--radius-select, var(--radius))` |
| `checkbox.tsx` | `var(--radius-checkbox, ...)` |
| `card.tsx` | `var(--radius-card, ...)` |
| `sheet.tsx` | (no radius variable) |

### What saves this
`globals.css` (lines 42–58) defines all 17 component-specific radius variables as defaults derived from `--radius`. These defaults work because the theme system DOES update `--radius` at runtime, and the CSS `var()` cascading resolves correctly.

### What `ThemeBorders` type is missing
`radiusInput`, `radiusDialog`, `radiusPopover`, `radiusDropdown`, `radiusTooltip`, `radiusBadge`, `radiusTabs`, `radiusSelect`, `radiusToast` — none of these are in the type, so they can never be stored in or read from the DB.

### Impact
The border radius for individual component types (input vs card vs dialog) is not independently controllable through the theme editor. Changing `--radius` changes ALL components proportionally via the CSS `calc()` derivations, which is acceptable but limits granularity.

### Recommendation
If independent component radius control is desired, add these fields to `ThemeBorders`, generate them in `applyBorderElements()`, and add editor UI controls.

---

## Issue 3: COMPONENT-SPECIFIC SHADOW VARIABLES NEVER GENERATED

**Severity: LOW** — Fallback pattern works correctly.

### What `globals.css` defines (lines 61–69)
```css
--shadow-button: var(--shadow-sm);
--shadow-card: var(--shadow-md);
--shadow-dialog: var(--shadow-2xl);
--shadow-popover: var(--shadow-lg);
--shadow-dropdown: var(--shadow-lg);
--shadow-tooltip: var(--shadow-sm);
--shadow-toast: var(--shadow-xl);
```

### What the theme system generates at runtime
Only the 8 base shadow variables (`--shadow-2xs` through `--shadow-2xl`). The `ThemeShadows` type only has these 8 fields.

### Impact
Component-specific shadows resolve via CSS variable cascading: `var(--shadow-card, var(--shadow-md))` → if `--shadow-card` isn't set, falls back to `--shadow-md` → which IS set by the theme. This works correctly but means shadow granularity (e.g., "make cards have a heavier shadow than dialogs") is not controllable from the theme editor.

---

## Issue 4: `generateSpacingCSS()` POTENTIAL BUG

**Severity: MEDIUM** — Generates malformed CSS if `themeData.spacing` has the `ThemeSpacing` structure.

### The function
```ts
function generateSpacingCSS(themeData: any): string {
  const spacing = themeData?.spacing;
  return Object.entries(spacing)
    .map(([key, value]) => `    --spacing-${key}: ${value};`)
    .join('\n');
}
```

### If `themeData.spacing` = `{ spacing: "2.2rem", scale: { xs: "0.25rem" } }`
This generates:
- `--spacing-spacing: 2.2rem;` (wrong — should be `--spacing: 2.2rem;`)
- `--spacing-scale: [object Object];` (broken — object serialized as string)

### Why it hasn't broken yet
The `spacing` field in the DB is `Json`. If saved from the theme editor, the structure may differ from the `ThemeSpacing` type. The SSR inline generator's `generateSpacingCSS()` calls `Object.entries()` on the raw JSON, which could produce unexpected keys.

The `applySpacingElements()` in the theme-editor has the same pattern but is protected by the check:
```ts
if (loadedTheme.spacing && Object.keys(loadedTheme.spacing).length > 0) {
  applySpacingElements(loadedTheme.spacing as unknown as Record<string, string>);
}
```

Meanwhile `applyThemeToRoot()` does it correctly: `root.style.setProperty('--spacing', theme.spacing.spacing);`

### Recommendation
Fix `generateSpacingCSS` to handle the `ThemeSpacing` type properly:
```ts
function generateSpacingCSS(themeData: any): string {
  const spacing = themeData?.spacing;
  if (!spacing?.spacing) return '';
  const properties: string[] = [`    --spacing: ${spacing.spacing};`];
  if (spacing.scale && typeof spacing.scale === 'object') {
    Object.entries(spacing.scale).forEach(([key, value]) => {
      if (typeof value === 'string') properties.push(`    --spacing-${key}: ${value};`);
    });
  }
  return properties.join('\n');
}
```

---

## Issue 5: `getAvailableVariables()` OUT OF SYNC

**Severity: LOW** — Only affects the export/documentation API, not rendering.

### COLOR category missing 10 variables
The `getAvailableVariables('color')` list includes `info` and `info-foreground` but is missing:
- `sidebar`, `sidebar-foreground`, `sidebar-primary`, `sidebar-primary-foreground`
- `sidebar-accent`, `sidebar-accent-foreground`, `sidebar-border`, `sidebar-ring`
- `scrollbar-track`, `scrollbar-thumb`

### `info`/`info-foreground` orphan
`--info` and `--info-foreground` are defined in `globals.css` dark mode (lines 164–165) and bridged via `--color-info: var(--info)` in the Tailwind `@theme inline` block (line 373), but they are **not** in the `ThemeColors` type or `CSS_VARIABLE_MAP`. The theme system cannot modify them.

### Recommendation
Add `info`/`infoForeground` to `ThemeColors` and `CSS_VARIABLE_MAP`, or remove them from `getAvailableVariables()`. Add the missing sidebar/scrollbar entries.

---

## Issue 6: `DbTheme` INTERFACE USES `any` FOR ALL JSON FIELDS

**Severity: LOW** — No runtime impact, but removes all type safety at the DB boundary.

### Current state (`inline-css-generator.ts`)
```ts
interface DbTheme {
  lightModeConfig: any;
  darkModeConfig: any;
  typography?: any;
  themeData?: any;
}
```

### Impact
Prisma returns `JsonValue` for Json fields. Casting everything to `any` means:
- No autocompletion when accessing nested theme properties
- No compile-time errors if the DB shape changes
- No validation that the stored JSON matches `ThemeColors`/`ThemeBorders`/etc.

### Recommendation
Create a `DbThemeData` type that mirrors the expected JSON structure and use it instead of `any`. Consider adding Zod validation at the read boundary.

---

## Issue 7: TRANSITION/Z-INDEX VARIABLES — STATIC ONLY

**Severity: INFO** — By design, not a bug.

`--transition-fast`, `--transition-base`, `--transition-slow`, `--transition-theme` and `--z-dropdown` through `--z-toast` are defined in `globals.css` (lines 111–124) but are **never generated** by any theme system function. They exist as static design tokens.

This is intentional — transitions and z-indices don't need per-theme customization. Listed here for completeness.

---

## Issue 8: TWO PARALLEL CSS VARIABLE GENERATORS

**Severity: INFO** — Intentional architecture split.

| File | Purpose | Used By |
|------|---------|---------|
| `lib/theme/css-variables.ts` | General-purpose injection API | Not called at runtime currently |
| `lib/theme/inline-css-generator.ts` | SSR `<style>` generation | `layout.tsx` (server-side) |
| `theme-editor-3.0/lib/utils/css/css-variables.ts` | Runtime DOM injection | `ThemeEditorContext` (client-side) |

The first file (`lib/theme/css-variables.ts`) appears to be a planned unified API that isn't yet wired into the main pipeline. The actual work is split between the inline generator (SSR) and the theme-editor's CSS module (client).

---

## Concordance Matrix

### Colors (DB → CSS Variable → UI Component)

| DB Field | CSS Variable | ThemeColors Key | In CSS_VARIABLE_MAP | Generated SSR | Generated Runtime | Used by UI |
|----------|-------------|-----------------|--------------------|--------------|--------------------|-----------|
| `lightModeConfig.primary` | `--primary` | `primary` | Yes | Yes | Yes | Yes |
| `lightModeConfig.info` | `--info` | **MISSING** | **NO** | No | No | Only `globals.css` |
| (38 other colors) | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

### Border Radius (DB → CSS Variable → UI Component)

| ThemeBorders Field | CSS Variable | In globals.css | SSR Generated | Runtime Generated | UI Components |
|-------------------|-------------|----------------|--------------|-------------------|---------------|
| `radius` | `--radius` | Yes | Yes | Yes | All (via calc) |
| `radiusCard` | `--radius-card` | Yes | Yes | Yes | card.tsx, sidebar.tsx |
| `radiusButton` | `--radius-button` | Yes | Yes | Yes | button.tsx |
| `radiusCheckbox` | `--radius-checkbox` | Yes | Yes | Yes | checkbox.tsx |
| **MISSING** | `--radius-input` | Yes | Yes (fallback) | **NO** | input.tsx |
| **MISSING** | `--radius-dialog` | Yes | Yes (fallback) | **NO** | dialog.tsx |
| **MISSING** | `--radius-select` | Yes | Yes (fallback) | **NO** | select.tsx |
| **MISSING** | `--radius-popover` | Yes | Yes (fallback) | **NO** | (none directly) |
| **MISSING** | `--radius-tooltip` | Yes | Yes (fallback) | **NO** | (none directly) |
| **MISSING** | `--radius-badge` | Yes | Yes (fallback) | **NO** | (none directly) |
| **MISSING** | `--radius-tabs` | Yes | Yes (fallback) | **NO** | (none directly) |
| **MISSING** | `--radius-toast` | Yes | Yes (fallback) | **NO** | (none directly) |

### Typography (DB → CSS Variable → UI Component)

| DB Field | CSS Variable | Generator | UI Component |
|----------|-------------|-----------|-------------|
| `typography` (System B) | `--typography-h1-*` | SSR (inline-generator) + Runtime (theme-editor) | (preview only) |
| `typography` (System B) | `--typography-paragraph-*` | SSR + Runtime | (preview only) |
| **NOT IN DB** | `--typography-input-*` | `globals.css` defaults only | `input.tsx`, `select.tsx` |
| **NOT IN DB** | `--typography-button-*` | `globals.css` defaults only | `button.tsx` |
| **NOT IN DB** | `--typography-label-*` | `globals.css` defaults only | `label.tsx` |

---

## Priority Summary

| # | Issue | Severity | Impact | Fix Effort |
|---|-------|----------|--------|------------|
| 1 | Three typography type systems | HIGH | Silent data mismatches SSR vs runtime | Large (type unification) |
| 4 | `generateSpacingCSS()` bug | MEDIUM | Malformed CSS if spacing is saved with ThemeSpacing shape | Small (fix function) |
| 2 | Missing component radii in runtime | MEDIUM | No per-component radius control | Medium |
| 5 | `getAvailableVariables()` out of sync | LOW | Wrong export/docs API | Small |
| 6 | `DbTheme` uses `any` | LOW | No type safety at DB boundary | Medium |
| 3 | Component shadows static only | LOW | No per-component shadow control | Medium |
| 7 | Transitions/z-index static | INFO | By design | None |
| 8 | Two parallel generators | INFO | Intentional architecture | None |
