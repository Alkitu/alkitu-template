# ALI-115: DB Authentication & Public Access (User + Auth)

## Metadata

- **Issue Key**: ALI-115
- **Type**: Tarea
- **Status**: ‚úÖ **DONE** (Completed 2025-11-24)
- **Priority**: Medium
- **Assignee**: Luis Eduardo Urdaneta Martucci
- **Reporter**: Leonel
- **Created**: 2025-11-18T02:59:04.723+0100
- **Updated**: 2025-11-24T00:15:00.000+0100
- **Sprint**: Dise√±o Interfaz y Data Base (ID: 37)
  - Start: 2025-11-23T21:19:39.908Z
  - End: 2025-11-30T21:19:06.000Z
- **Implementation Time**: ~6 hours
- **Tests**: 10/10 E2E + 20+ Unit (100% passing)

## Parent Epic

- **Key**: ALI-18
- **Summary**: Data Base [Global]
- **Status**: Discovery

## Description

Definir y configurar toda la parte de base de datos necesaria para registro, login y recuperaci√≥n de contrase√±a.
Incluye el uso m√≠nimo del modelo `User` (`email`, `password`, `role`, `createdAt`, `updatedAt`) y su integraci√≥n con los endpoints de autenticaci√≥n.

**Modelos / campos clave:**

- `User.email` (√∫nico)
- `User.password` (hash)
- `User.role` (default CLIENT)
- `User.profileComplete` (default false)

### ¬øD√≥nde se usa en el sitemap?

**Pantallas:**

- **Landing Page ‚Äì "Welcome & Access Entry" [Global] (ALI-53)**
  - No lee datos de BD, pero es la puerta hacia:
    - Bot√≥n "Login" ‚Üí flujo que usar√° `User.email` + `User.password`.
    - Bot√≥n "Register" ‚Üí flujo que crear√° un nuevo `User`.

- **Register ‚Äì "Create Your Account" [Global] (ALI-21)**
  - Crea un `User` m√≠nimo con:
    - `email` (campo del formulario).
    - `password` (formulario, se guarda hasheada).
    - `role` ‚Üí valor por defecto `CLIENT`.
    - `profileComplete` ‚Üí `false` por defecto.
    - `createdAt`, `updatedAt` ‚Üí seteados autom√°ticamente.

  - Tras registro, redirige al onboarding de perfil.

- **Login ‚Äì "Sign In to Your Account" [Global] (ALI-22)**
  - Usa:
    - `email` + `password` para autenticar.

  - Seg√∫n el usuario recuperado:
    - `role` decide qu√© dashboard mostrar.
    - `profileComplete` decide si va directo a `/app/dashboard` o al onboarding de perfil.

- **Password Reset ‚Äì "Recover Your Access" (ALI-23)**
  - Se apoya en `User.email` para:
    - Encontrar al usuario que solicita el reset.
    - Enviar el enlace de recuperaci√≥n.

  - Al confirmar nueva contrase√±a:
    - Actualiza `User.password` y `updatedAt`.

## Schema Definition

```prisma
/// EPIC DB-1 ‚Äì Authentication & Public Access (User + Auth)

type ContactPerson {
  name     String
  lastname String
  phone    String
  email    String
}

enum Role {
  CLIENT
  EMPLOYEE
  ADMIN
}

model User {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  email            String          @unique
  password         String
  firstname        String
  lastname         String
  phone            String
  company          String
  address          String?         // Main Address (relevante para CLIENT)
  contactPerson    ContactPerson?
  role             Role            @default(CLIENT)
  profileComplete  Boolean         @default(false)
  locations        WorkLocation[]  @relation("UserLocations")
  requests         Request[]       @relation("UserRequests")
  assignedRequests Request[]       @relation("RequestAssignedEmployee")
  notifications    Notification[]  @relation("UserNotifications")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}
```

## Related Issues

- **ALI-53**: Landing Page ‚Äì "Welcome & Access Entry" [Global]
- **ALI-21**: dev Register ‚Äì "Create Your Account" [Global]
- **ALI-22**: dev Login ‚Äì "Sign In to Your Account" [Global]
- **ALI-23**: dev Password Reset ‚Äì "Recover Your Access"

## Implementation Summary

### ‚úÖ Completado (100%)

**Database**:

- ‚úÖ Schema migrado con todos los campos requeridos
- ‚úÖ ContactPerson type implementado
- ‚úÖ profileComplete field con l√≥gica completa
- ‚úÖ √çndices y constraints configurados

**Backend** (95%+ coverage):

- ‚úÖ Register endpoint con campos m√≠nimos
- ‚úÖ Login endpoint con JWT + profileComplete
- ‚úÖ Password reset flow completo
- ‚úÖ Email verification
- ‚úÖ Rate limiting (5 login/min, 20 register/hour)
- ‚úÖ Password complexity validation
- ‚úÖ Endpoint `/auth/complete-profile`

**Frontend** (100% nuevos componentes):

- ‚úÖ PasswordStrengthIndicator component
- ‚úÖ RegisterFormOrganism (campos m√≠nimos)
- ‚úÖ OnboardingFormOrganism (campos adicionales)
- ‚úÖ Onboarding page `/app/onboarding`
- ‚úÖ Middleware con profileComplete logic
- ‚úÖ Redirect basado en profileComplete

**Tests**:

- ‚úÖ Backend: 95%+ coverage, 85%+ mutation score
- ‚úÖ Frontend: 10/10 E2E (Playwright), 20+ Unit (Vitest)
- ‚úÖ Zero linting errors
- ‚úÖ Zero TypeScript errors

### üìö Documentation

- **Spec**: `/jira/sprint-1/specs/ALI-115/ALI-115-auth-spec.md`
- **Frontend Implementation**: `/jira/sprint-1/specs/ALI-115/ALI-115-auth-frontend-feedback.md`
- **Backend Implementation**: `/jira/sprint-1/specs/ALI-115/ALI-115-auth-backend-feedback.md`

### üéØ User Flows Implemented

1. **Register** ‚Üí Email verification ‚Üí Login ‚Üí Onboarding (if profileComplete=false) ‚Üí Dashboard
2. **Login** ‚Üí profileComplete check ‚Üí Onboarding OR Dashboard
3. **Password Reset** ‚Üí Email ‚Üí New password ‚Üí Login
4. **Onboarding** ‚Üí Complete profile (optional) ‚Üí Dashboard

### üöÄ Status

**PRODUCTION READY** - All acceptance criteria met, tests passing, documentation complete.

## Links

- [View in Jira](https://alkitu.atlassian.net/browse/ALI-115)
