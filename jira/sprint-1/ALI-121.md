# ALI-121: DB Email Templates & Automation (EmailTemplate)

## Metadata
- **Issue Key**: ALI-121
- **Type**: Tarea
- **Status**: Discovery
- **Priority**: Medium
- **Assignee**: Luis Eduardo Urdaneta Martucci
- **Created**: 2025-11-18T03:00:01.747+0100
- **Updated**: 2025-11-23T22:07:23.250+0100
- **Sprint**: Diseño Interfaz y Data Base (ID: 37)

## Description

Definir cómo se almacenan y parametrizan las plantillas de correo automáticas ligadas a eventos de creación y cambio de estado de las solicitudes.

**Modelos / campos clave:**

* `EmailTemplate.name`
* `EmailTemplate.subject`
* `EmailTemplate.body`
* `EmailTemplate.trigger` (`ON_REQUEST_CREATED`, `ON_STATUS_CHANGED`)
* `EmailTemplate.status?` (solo cuando el trigger está asociado a un cambio de estado concreto)

### ¿Dónde se usa en el sitemap?

**Pantallas:**

* **Email Automation – "Email Templates Manager" [Admin] (ALI-57)**

    * Lista y edita los registros `EmailTemplate`:

        * `name` como identificador interno.
        * `subject` (asunto que verá el usuario).
        * `body` (texto del correo con placeholders).
        * `trigger` (ON_REQUEST_CREATED / ON_STATUS_CHANGED).
        * `status?` (estado específico cuando el trigger es por cambio de estado).


* **Flujo de Requests (sin pantalla directa)**

    * Al crear un `Request`:

        * Se busca plantilla con `trigger = ON_REQUEST_CREATED`.

    * Al cambiar `Request.status`:

        * Se busca plantilla con `trigger = ON_STATUS_CHANGED` + `status` correspondiente.

    * Los datos de la solicitud se inyectan en los placeholders del `body` antes de enviar.

## Schema Definition

```prisma
/// EPIC DB-7 – Email Templates & Automation (EmailTemplate)

enum TemplateTrigger {
  ON_REQUEST_CREATED
  ON_STATUS_CHANGED
}

model EmailTemplate {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  subject   String
  body      String
  trigger   TemplateTrigger
  status    RequestStatus?  // Solo para ON_STATUS_CHANGED
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}
```

## Links
- [View in Jira](https://alkitu.atlassian.net/browse/ALI-121)
