# ALI-122: DB Users & Roles Management (Admin View)

## Metadata
- **Issue Key**: ALI-122
- **Type**: Tarea
- **Status**: Done ✅
- **Priority**: Medium
- **Assignee**: Luis Eduardo Urdaneta Martucci
- **Created**: 2025-11-18T03:00:12.539+0100
- **Updated**: 2025-12-26T00:00:00.000+0100
- **Sprint**: Diseño Interfaz y Data Base (ID: 37)
- **Completed**: 2025-12-26T00:00:00.000+0100

## Description

Aprovechar el modelo `User` para ofrecer al Admin una vista de gestión de equipo (Admins/Employees) y consulta de clientes, controlando roles y permisos desde BD.

**Modelos / campos clave:**

* `User.role` (CLIENT, EMPLOYEE, ADMIN)
* Datos básicos: `firstname`, `lastname`, `email`, `phone`, `company`

### ¿Dónde se usa en el sitemap?

**Pantallas:**

* **Users – "Team & Clients Management" [Admin] (ALI-58)**

    * Pestaña **Team**:

        * Lista usuarios donde `role IN (ADMIN, EMPLOYEE)`.
        * Muestra por cada uno: `firstname`, `lastname`, `email`, `phone`, `role`, `company`.
        * Formulario de alta:

            * Crea nuevo `User` con `role = EMPLOYEE` o `ADMIN`.

        * Edición:

            * Modificar datos básicos y rol.

        * Eliminación / desactivación:

            * Según política de negocio (soft delete o flags).


    * Pestaña **Clients**:

        * Lista usuarios con `role = CLIENT`.
        * Solo lectura:

            * Muestra datos básicos (`firstname`, `lastname`, `email`, `phone`, `company`, `address`).
            * Sin acciones de editar/eliminar desde esta pantalla (solo consulta).



* **Admin Dashboard – "Operations & Metrics Overview" [Admin] (ALI-28)**

    * Puede usar información de `User` para:

        * KPIs como nº de clientes activos, nº de empleados, etc.
        * Gráficos basados en `role`.

## Schema Definition

```prisma
/// EPIC DB-8 – Users & Roles Management (Admin View)

enum Role {
  CLIENT
  EMPLOYEE
  ADMIN
}

model User {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  email            String          @unique
  password         String
  firstname        String
  lastname         String
  phone            String
  company          String
  address          String?         // Main Address (relevante para CLIENT)
  contactPerson    ContactPerson?
  role             Role            @default(CLIENT)
  profileComplete  Boolean         @default(false)
  locations        WorkLocation[]  @relation("UserLocations")
  requests         Request[]       @relation("UserRequests")
  assignedRequests Request[]       @relation("RequestAssignedEmployee")
  notifications    Notification[]  @relation("UserNotifications")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

type ContactPerson {
  name     String
  lastname String
  phone    String
  email    String
}
```

## Implementation Status

### ✅ Completed Features

#### 1. Team/Clients Tab Separation
**File**: `packages/web/src/app/[lang]/(private)/admin/users/page.tsx`

- **Team Tab**:
  - Lists users with `role IN (ADMIN, EMPLOYEE)` (23 users)
  - Full CRUD capabilities (Create, Edit, Delete)
  - Bulk operations enabled (Activate, Deactivate, Delete)
  - Role filtering available
  - "Add User" button visible

- **Clients Tab**:
  - Lists users with `role = CLIENT` (320 users)
  - Read-only mode (no edit/delete actions)
  - Shows additional `address` column
  - Bulk actions hidden
  - Checkboxes hidden
  - Row action dropdowns hidden
  - Role filter hidden

#### 2. Backend Support
**Files Modified**:
- `packages/api/src/users/dto/filter-users.dto.ts` (lines 26-33)
  - Added `teamOnly` boolean parameter for filtering ADMIN + EMPLOYEE

- `packages/api/src/users/users.service.ts` (lines 159-164)
  - Implemented `teamOnly` filter logic in `findAllWithFilters()` method

- `packages/api/src/trpc/routers/user.router.ts` (line 104)
  - Added `teamOnly` to tRPC schema for type-safe filtering

#### 3. Dashboard KPIs
**File**: `packages/web/src/app/[lang]/(private)/admin/dashboard/page.tsx`

- **4 Main KPI Cards**:
  - Total Usuarios: 343
  - Clientes: 320
  - Empleados: 13
  - Administradores: 10

- **Recent Activity Card**:
  - Shows new users in last 30 days: 178
  - Progress bar visualization

- **User Distribution Card**:
  - Clientes: 93%
  - Empleados: 4%
  - Admins: 3%
  - Visual progress bars with percentages

### Testing Results

✅ **Team Tab**: Verified 23 users (ADMIN + EMPLOYEE only)
✅ **Clients Tab**: Verified 320 users (CLIENT only)
✅ **Read-Only Mode**: All restrictions working correctly
✅ **Dashboard KPIs**: Real data loading from `getUserStats` endpoint
✅ **Data Integrity**: All calculations and percentages accurate

### Screenshots
- `.playwright-mcp/admin-users-team-tab.png`
- `.playwright-mcp/admin-users-clients-tab.png`
- `.playwright-mcp/admin-dashboard-kpis-loaded.png`

### Database Schema
All required fields from the `User` model are being used:
- ✅ `role` (CLIENT, EMPLOYEE, ADMIN)
- ✅ `firstname`, `lastname`, `email`, `phone`, `company`
- ✅ `address` (shown only in Clients tab)

### Integration Points
- ✅ Connected with existing `UsersService`
- ✅ Using existing `getUserStats()` method
- ✅ tRPC type-safe API layer
- ✅ Proper role-based filtering with Prisma

## Links
- [View in Jira](https://alkitu.atlassian.net/browse/ALI-122)
